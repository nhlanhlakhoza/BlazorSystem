@page "/inspector"
@using Microsoft.AspNetCore.Components.Forms
@inject IJSRuntime JSRuntime
@inject HttpClient Http
@using Radzel_test.Components.Services
@using Radzen
@inject UserStateService UserStateService
@rendermode InteractiveServer
@inject HttpClient Http

<PageTitle>Inspector - Tasks Management</PageTitle>

<div class="users-container">
    <div class="page-header">
        <h1><i class="fas fa-tasks"></i> Pending Inspector Tasks</h1>
    </div>

    <div class="quick-actions">
        <button class="action-btn refresh" @onclick="RefreshData">
            <i class="fas fa-sync-alt"></i>
            Refresh Tasks
        </button>
    </div>

    <div class="search-section">
        <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" @bind="SearchTerm" @bind:event="oninput" placeholder="Search tasks by case name or location..." />
        </div>
    </div>

    <div class="users-table-container">
        <div class="table-header">
            <h2><i class="fas fa-list"></i> Pending Tasks</h2>
            <div class="table-actions">
                <span>@FilteredTasks.Count tasks</span>
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Case Name</th>
                    <th>Location</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var task in PagedTasks)
                {
                    <tr>
                        <td>@task.Title</td>
                        <td>@task.Location</td>
                        <td>
                            <span class="status-badge status-@task.Status">@task.Status</span>
                        </td>
                        <td>
                           

                             <button class="icon-btn view-btn" @onclick="() => OpenTaskModalFunc(task)">
                                <i class="fas fa-eye"></i> Complete Task
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="pager-container">
            <RadzenPager Count="@count"
                         PageSize="@pageSize"
                         PageNumbersCount="6"
                         PageChanged="@PageChanged" />
        </div>
    </div>
</div>

@if (ShowModal)
{
    <div class="modal-overlay">
        <div class="modal-content modal-lg">

            <div class="modal-header">
                <h3>Complete Task</h3>
                <button class="close-btn" @onclick="CloseModal">&times;</button>
            </div>

            <EditForm Model="@CurrentTask" OnValidSubmit="SaveTask">
                <DataAnnotationsValidator />

                <div class="form-group">
                    <label>Case Name</label>
                    <InputText class="form-control"
                               @bind-Value="CurrentTask.Title"
                               disabled />
                </div>

                <div class="form-group">
                    <label>Location</label>
                    <InputText class="form-control"
                               @bind-Value="CurrentTask.Location"
                               disabled />
                </div>

                <div class="form-group">
                    <label>Notes *</label>
                    <InputTextArea class="form-control"
                                   @bind-Value="CurrentTask.Notes"
                                   placeholder="Enter task notes..." />
                </div>

                <!-- ?? IMAGES -->
                <div class="form-group">
                    <label>Upload Pictures (multiple)</label>

                    <InputFile multiple
                               accept="image/*"
                               OnChange="OnPicturesSelected" />

                    @if (CurrentTask.Pictures.Any())
                    {
                        <div class="uploaded-images">
                            @foreach (var img in CurrentTask.Pictures)
                            {
                                <div class="image-thumb">
                                    <img src="@img.DataUrl" />
                                    <button type="button"
                                            class="remove-image"
                                            @onclick="() => RemovePicture(img)">
                                        ×
                                    </button>
                                </div>
                            }
                        </div>
                    }
                </div>

                <!-- ?? PDF -->
                <div class="form-group">
                    <label>Upload PDF (1 file only)</label>

                    <InputFile accept="application/pdf"
                               OnChange="OnPdfSelected" />

                    @if (!string.IsNullOrEmpty(CurrentTask.PdfName))
                    {
                        <div class="pdf-file">
                            <i class="fas fa-file-pdf"></i>
                            <span>@CurrentTask.PdfName</span>
                            <button type="button"
                                    class="remove-pdf"
                                    @onclick="RemovePdf">
                                Remove
                            </button>
                        </div>
                    }
                </div>

                <div class="form-actions">
                    <button type="button"
                            class="btn btn-secondary"
                            @onclick="CloseModal">
                        Cancel
                    </button>

                    <button type="submit"
                            class="btn btn-primary">
                        Save & Complete
                    </button>
                </div>
            </EditForm>

        </div>
    </div>
}

@if (IsLoading)
{
    <div class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>@LoadingMessage</p>
        </div>
    </div>
}


@code {
    private List<InspectorTask> Tasks = new();
    private List<InspectorTask> FilteredTasks = new();
    private InspectorTask CurrentTask = new();
    private bool ShowModal = false;
    private bool IsLoading = false;
    private string LoadingMessage = "";
    private string searchTerm = "";
    private int pageSize = 4;
    private int pageIndex = 0;
    private int count => FilteredTasks.Count;
    private string ErrorMessage = "";
    private string SuccessMessage = "";
    private IEnumerable<InspectorTask> PagedTasks => FilteredTasks.Skip(pageIndex * pageSize).Take(pageSize);
    private async Task OnPicturesSelected(InputFileChangeEventArgs e)
{
    long maxSize = 5 * 1024 * 1024; 

    foreach (var file in e.GetMultipleFiles())
    {
        if (file.Size > maxSize)
            continue;

        using var ms = new MemoryStream();
        await file.OpenReadStream(maxSize).CopyToAsync(ms);

        CurrentTask.Pictures.Add(new TaskImage
        {
            FileName = file.Name,
            DataUrl = $"data:{file.ContentType};base64,{Convert.ToBase64String(ms.ToArray())}"
        });
    }
}

private async Task OnPdfSelected(InputFileChangeEventArgs e)
{
    var file = e.File;
    if (file == null) return;

    long maxSize = 10 * 1024 * 1024; 

    using var ms = new MemoryStream();
    await file.OpenReadStream(maxSize).CopyToAsync(ms);

   
    CurrentTask.PdfName = file.Name;
    CurrentTask.PdfBytes = ms.ToArray();
}

private void RemovePicture(TaskImage img)
{
    CurrentTask.Pictures.Remove(img);
}

private void RemovePdf()
{
    CurrentTask.PdfName = string.Empty;
    CurrentTask.PdfBytes = null;
}

    private string SearchTerm
    {
        get => searchTerm;
        set { searchTerm = value; FilterTasks(); }
    }

    protected override void OnInitialized()
    {
        LoadSampleData();
        FilterTasks();
    }

    private async Task LoadSampleData()
    {
        try
        {
            IsLoading = true;
            LoadingMessage = "Loading tasks...";
            StateHasChanged();

            // Current inspector id (string)
            var currentInspectorId = UserStateService.UserId;

            // Get all tasks
            var allTasks = await Http.GetFromJsonAsync<List<InspectorTask>>("https://localhost:7272/api/tasks/all");

            if (allTasks != null)
            {
                // Filter by AgentId and pending status
                Tasks = allTasks
                    .Where(t => t.AgentId == currentInspectorId &&
                                t.Status?.Trim().ToLower() == "pending")
                    .ToList();

                // If you have a search term, filter it too
                FilterTasks();

                // Force UI update
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "Failed to load tasks: " + ex.Message;
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }




    private void FilterTasks()
    {
        FilteredTasks = Tasks.Where(t => t.Status == "Pending" &&
                                         (string.IsNullOrEmpty(SearchTerm) ||
                                          t.Title.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ||
                                          t.Location.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)))
                             .ToList();
    }

    void PageChanged(Radzen.PagerEventArgs args) => pageIndex = args.PageIndex;

    private void OpenTaskModalFunc(InspectorTask task)
    {
        CurrentTask = task;
        if (CurrentTask.Pictures == null) CurrentTask.Pictures = new List<TaskImage>();
        ShowModal = true;
    }

    private void CloseModal()
    {
        ShowModal = false;
        SuccessMessage = "";
        ErrorMessage = "";
        CurrentTask = new InspectorTask();
    }

    private async Task SaveTask()
    {
        try
        {
            IsLoading = true;
            LoadingMessage = "Saving task...";
            StateHasChanged();

            using var content = new MultipartFormDataContent();

          
            if (!string.IsNullOrEmpty(CurrentTask.Notes))
                content.Add(new StringContent(CurrentTask.Notes), "Notes");

           
            if (!string.IsNullOrEmpty(CurrentTask.PdfName) && CurrentTask.PdfBytes != null)
            {
                var pdfContent = new ByteArrayContent(CurrentTask.PdfBytes);
                pdfContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/pdf");
                content.Add(pdfContent, "PdfFile", CurrentTask.PdfName);
            }

          
            foreach (var img in CurrentTask.Pictures)
            {
                var bytes = Convert.FromBase64String(img.DataUrl.Split(',')[1]);
                var imgContent = new ByteArrayContent(bytes);
                imgContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("image/png"); 
                content.Add(imgContent, "Images", img.FileName);
            }

           
            var response = await Http.PutAsync($"https://localhost:7272/api/tasks/inspector/{CurrentTask.Id}", content);

            if (response.IsSuccessStatusCode)
            {
               
                if (!string.IsNullOrEmpty(CurrentTask.Notes) && !string.IsNullOrEmpty(CurrentTask.PdfName))
                    CurrentTask.Status = "Completed";

               
                var index = Tasks.FindIndex(t => t.Id == CurrentTask.Id);
                if (index >= 0) Tasks[index] = CurrentTask;

                FilterTasks();
                SuccessMessage = "Task updated successfully!";
                await Task.Delay(1500);
                CloseModal();
            }
            else
            {
                ErrorMessage = $"Failed to save task. Status code: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "Unexpected error: " + ex.Message;
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshData()
    {
        IsLoading = true;
        LoadingMessage = "Refreshing tasks...";
        StateHasChanged();
        await Task.Delay(1000);
        LoadSampleData();
        FilterTasks();
        IsLoading = false;
    }

    private async Task OnPictureSelected(InputFileChangeEventArgs e)
    {
        long maxFileSize = 50 * 1024 * 1024;

        foreach (var file in e.GetMultipleFiles())
        {
            if (file.Size > maxFileSize)
            {
                await JSRuntime.InvokeVoidAsync("alert", $"File {file.Name} is too large. Max 50 MB allowed.");
                continue;
            }

            var buffer = new byte[file.Size];
            await file.OpenReadStream(maxFileSize).ReadAsync(buffer);
            var base64 = Convert.ToBase64String(buffer);
            CurrentTask.Pictures.Add(new TaskImage { FileName = file.Name, DataUrl = $"data:{file.ContentType};base64,{base64}" });
        }
    }


   
   

    public class InspectorTask
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string Location { get; set; } = string.Empty;
        public string Notes { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public string AgentId { get; set; } = string.Empty;
        public string PdfName { get; set; } = string.Empty;
        public byte[]? PdfBytes { get; set; }

       
        public List<TaskImage> Pictures { get; set; } = new();
    }

    public class TaskImage
    {
        public string FileName { get; set; } = "";
        public string DataUrl { get; set; } = "";
    }

}
