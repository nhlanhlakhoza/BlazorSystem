@page "/"
@layout BlankLayout
@rendermode InteractiveServer
@using Radzel_test.Components.Services
@using Radzen
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@using System.ComponentModel.DataAnnotations
@using backendMpact.Models
@inject HttpClient Http
<RadzenNotification></RadzenNotification>
@inject IJSRuntime JS
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@using System.IdentityModel.Tokens.Jwt;
@inject UserStateService UserState


<!-- Loading Indicator -->
@if (isLoading)
{
    <div class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Please wait..</p>
        </div>
    </div>
}

@if (showError)
{
    <div class="centered-notification">
        <div class="notification-box">
            Invalid Credentials. Please try again.
        </div>
    </div>
}
 <HeadContent>
 <link href="css/site.css" rel="stylesheet" />
 <link href="~/app.css" rel="stylesheet" />
 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

</HeadContent>
<div class="d-flex justify-content-center align-items-center vh-100 login-background">
    <RadzenCard class="card p-4 shadow transparent-card" style="width: 400px;">

        <div class="text-center mb-4">
            <img src="images/mpact.png" alt="logo" class="img-fluid mb-3" style="padding-left: 30px;" />
            <h4 class="fw-bold text-black mb-1" style="margin-top: -28px;">Welcome Back</h4>
            <h5 class="fw-bold text-info text-black mb-3">Login</h5>
        </div>


        <EditForm Model="@loginModel" OnValidSubmit="@OnLoginCustom">
            <DataAnnotationsValidator />


            <div class="mb-3">
                <div class="input-group">
                    <span class="input-group-text bg-secondary text-white">
                        <i class="bi bi-envelope-fill"></i>
                    </span>
                    <InputText @bind-Value="loginModel.Email" class="form-control" placeholder="Email Address" />
                </div>
                <ValidationMessage For="@(() => loginModel.Email)" />
            </div>


            <div class="mb-3 ">
                <div class="input-group">
                    <span class="input-group-text bg-secondary text-white">
                        <i class="bi bi-lock-fill"></i>
                    </span>
                    <InputText @bind-Value="loginModel.Password" type="password" class="form-control" placeholder="Password" />
                </div>
                <ValidationMessage For="@(() => loginModel.Password)" />
            </div>


            <button type="submit" class="btn btn-custom">Login</button>
            <p class="mt-3 fw-bold text-black">
                Forgot password?
                <a href="#" style="font-weight:bold;color:white">Reset</a>
            </p>
        </EditForm>

    </RadzenCard>
</div>

@code {
    private bool isLoading = false;
    private bool showError = false;
    private LoginModel loginModel = new();

    private async Task OnLoginCustom()
    {
        isLoading = true;
        showError = false;
        StateHasChanged();

        try
        {

            var response = await Http.PostAsJsonAsync("https://localhost:7272/api/users/login", loginModel);

            if (response.IsSuccessStatusCode)
            {
                // Read the response (token + message) into 'result'
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();

                // Save token in localStorage
                await JS.InvokeVoidAsync("localStorage.setItem", "authToken", result.Token);
                var handler = new JwtSecurityTokenHandler();
                var jwtToken = handler.ReadJwtToken(result.Token);

                // Extract claims
                string userName = jwtToken.Claims.FirstOrDefault(c => c.Type == "FullName")?.Value ?? "N/A";
                string userEmail = jwtToken.Claims.FirstOrDefault(c => c.Type == "Email")?.Value ?? "N/A";
                string userRole = jwtToken.Claims.FirstOrDefault(c => c.Type == "Role")?.Value ?? "N/A";

                // Store in sessionStorage
                await sessionStorage.SetItemAsync("userName", userName);
                await sessionStorage.SetItemAsync("userEmail", userEmail);
                await sessionStorage.SetItemAsync("userRole", userRole);

              


                isLoading = false;
                StateHasChanged();

                Navigation.NavigateTo("/users");
            }

            else
            {

                isLoading = false;
                showError = true;
                StateHasChanged();


                await Task.Delay(3000);
                showError = false;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {

            isLoading = false;
            showError = true;
            StateHasChanged();

            Console.WriteLine("Login error: " + ex.Message);

            await Task.Delay(3000);
            showError = false;
            StateHasChanged();
        }
    }

    public class LoginModel
    {
        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email address")]
        public string Email { get; set; }

        [Required(ErrorMessage = "Password is required")]
        public string Password { get; set; }
    }
}
